<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lotteria</title>
<style>
  /* ...stili come prima... */
</style>
</head>
<body>
  <h1>Scegli i tuoi numeri!</h1>
  <input type="text" id="parentName" placeholder="Inserisci il tuo nome" />
  <div class="grid" id="numberGrid"></div>
  <button onclick="confirmSelection()">Conferma</button>
  <p id="message"></p>

  <script>
    const PROXY_URL = "https://corsproxy.io/?";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyNRy0PNmPJr3NkrHfGgpnAVpQ7Sm4pLmq87NcWZxlsKIzsXE9X96eosde-6LV9ITw/exec";

    const grid = document.getElementById('numberGrid');
    const message = document.getElementById('message');
    let selectedNumbers = [];
    let reservations = {};

    async function loadReservations() {
      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(SCRIPT_URL));
        reservations = await response.json();
        renderGrid();
      } catch (error) {
        console.error('Errore nel caricamento delle prenotazioni:', error);
      }
    }

    function renderGrid() {
      grid.innerHTML = '';
      for (let i = 1; i <= 90; i++) {
        const numberDiv = document.createElement('div');
        numberDiv.className = 'number';

        if (reservations[i]) {
          numberDiv.classList.add('reserved');
          numberDiv.textContent = `${i}\n${reservations[i]}`;
          numberDiv.title = `Prenotato da ${reservations[i]}`;
        } else {
          numberDiv.textContent = i;
          numberDiv.onclick = () => toggleSelectNumber(i, numberDiv);
          if (selectedNumbers.includes(i)) {
            numberDiv.classList.add('selected');
          }
        }
        grid.appendChild(numberDiv);
      }
    }

    function toggleSelectNumber(number, element) {
      if (selectedNumbers.includes(number)) {
        selectedNumbers = selectedNumbers.filter(n => n !== number);
        element.classList.remove('selected');
      } else if (!reservations[number]) {
        selectedNumbers.push(number);
        element.classList.add('selected');
      }
    }

    async function confirmSelection() {
      const name = document.getElementById('parentName').value.trim();
      if (!name) {
        alert('Inserisci il tuo nome!');
        return;
      }
      if (selectedNumbers.length === 0) {
        alert('Seleziona almeno un numero!');
        return;
      }

      try {
        const response = await fetch(PROXY_URL + encodeURIComponent(SCRIPT_URL), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, numbers: selectedNumbers })
        });
        const result = await response.text();

        if (result === 'Success') {
          selectedNumbers.forEach(num => {
            reservations[num] = name;
          });
          message.textContent = `${name}, hai scelto i numeri: ${selectedNumbers.join(', ')}`;
          selectedNumbers = [];
          renderGrid();
        } else {
          alert(result);
        }
      } catch (error) {
        alert('Errore: ' + error);
      }
    }

    loadReservations();
  </script>
</body>
</html>
